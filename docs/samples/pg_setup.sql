DROP DATABASE MVT;
drop role mvt_admin;
drop role mvt_user;
drop role mvt;
CREATE DATABASE MVT ENCODING 'UTF8';

-- MVT Group Role
CREATE ROLE MVT WITH 
    NOSUPERUSER
    NOCREATEDB
    NOCREATEROLE
    INHERIT
    NOLOGIN;

-- MVT Admin Role
CREATE ROLE MVT_ADMIN WITH
    PASSWORD '6Ug8e352942kQcz' -- temp pass - change this
    NOSUPERUSER
    NOCREATEDB
    NOCREATEROLE
    INHERIT
    LOGIN
    IN ROLE MVT
    ;

-- MVT General User Role
CREATE ROLE MVT_USER WITH
    PASSWORD '9Ep7XgAMDZnYW6V' -- temp pass - change this
    NOSUPERUSER
    NOCREATEDB
    NOCREATEROLE
    NOREPLICATION
    INHERIT
    LOGIN
    IN ROLE MVT
    ;

\c mvt;


-- Allows current user to alter the privs for the member groups
GRANT MVT_ADMIN TO current_user;
GRANT MVT to current_user;

CREATE EXTENSION IF NOT EXISTS POSTGIS;

CREATE SCHEMA GRAVA AUTHORIZATION MVT;

-- Setup the search paths properly
ALTER USER MVT_ADMIN SET search_path = MVT, PUBLIC;
ALTER USER MVT_USER SET search_path = MVT, PUBLIC;


-- Set default perms for the group role which both the admin and user roles will inherit.
GRANT CONNECT ON DATABASE MVT to MVT;
GRANT USAGE ON LANGUAGE PLPGSQL TO MVT;
GRANT USAGE ON SCHEMA GRAVA TO MVT;
GRANT USAGE ON ALL SEQUENCES IN SCHEMA GRAVA TO MVT;

ALTER DEFAULT PRIVILEGES FOR ROLE MVT_ADMIN IN SCHEMA GRAVA GRANT EXECUTE ON FUNCTIONS TO MVT;
ALTER DEFAULT PRIVILEGES FOR ROLE MVT_ADMIN IN SCHEMA GRAVA GRANT USAGE, SELECT ON SEQUENCES TO MVT;
ALTER DEFAULT PRIVILEGES FOR ROLE MVT_ADMIN IN SCHEMA GRAVA GRANT SELECT, REFERENCES, TRIGGER ON TABLES TO MVT;
ALTER DEFAULT PRIVILEGES FOR ROLE MVT_ADMIN IN SCHEMA GRAVA GRANT SELECT ON SEQUENCES TO MVT;

-- Special extended privs for mvt_admin to do table work
GRANT ALL ON SCHEMA GRAVA TO MVT_ADMIN;
ALTER DEFAULT PRIVILEGES IN SCHEMA GRAVA GRANT ALL ON SEQUENCES TO MVT_ADMIN;
ALTER DEFAULT PRIVILEGES IN SCHEMA GRAVA GRANT ALL ON FUNCTIONS TO MVT_ADMIN;
ALTER DEFAULT PRIVILEGES IN SCHEMA GRAVA GRANT ALL ON TABLES TO MVT_ADMIN WITH GRANT OPTION;